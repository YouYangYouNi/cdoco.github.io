<!DOCTYPE HTML>
<html lang="en-US" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=11; IE=10; IE=9; IE=8; IE=7; IE=EDGE" />
        <title>版本控制 | Elasticsearch 权威指南（中文版）</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 1.4.1">
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    
    
    <link rel="next" href="../030_Data/45_Partial_update.html" />
    
    
    <link rel="prev" href="../030_Data/35_Delete.html" />
    

        
    </head>
    <body>
        
        
<link rel="stylesheet" href="../gitbook/style.css">


        
    <div class="book" data-level="3.8" data-basepath=".." data-revision="1418205808702">
    

<div class="book-summary">
    <div class="book-search">
        <input type="text" placeholder="Type to search" class="form-control" />
    </div>
    <ul class="summary">
        
    	
    	
    	

        

        
    
        
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                        <i class="fa fa-check"></i>
                        
                         Introduction
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1" data-path="010_Intro/00_README.html">
            
                
                    <a href="../010_Intro/00_README.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                         入门
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="1.1" data-path="010_Intro/05_What_is_it.html">
            
                
                    <a href="../010_Intro/05_What_is_it.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                         是什么
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.2" data-path="010_Intro/10_Installing_ES.html">
            
                
                    <a href="../010_Intro/10_Installing_ES.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                         安装
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.3" data-path="010_Intro/15_API.html">
            
                
                    <a href="../010_Intro/15_API.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.3.</b>
                        
                         API
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.4" data-path="010_Intro/20_Document.html">
            
                
                    <a href="../010_Intro/20_Document.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.4.</b>
                        
                         文档
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.5" data-path="010_Intro/25_Tutorial_Indexing.html">
            
                
                    <a href="../010_Intro/25_Tutorial_Indexing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.5.</b>
                        
                         索引
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.6" data-path="010_Intro/30_Tutorial_Search.html">
            
                
                    <a href="../010_Intro/30_Tutorial_Search.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.6.</b>
                        
                         搜索
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.7" data-path="010_Intro/35_Tutorial_Aggregations.html">
            
                
                    <a href="../010_Intro/35_Tutorial_Aggregations.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.7.</b>
                        
                         聚合
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.8" data-path="010_Intro/40_Tutorial_Conclusion.html">
            
                
                    <a href="../010_Intro/40_Tutorial_Conclusion.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.8.</b>
                        
                         小结
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.9" data-path="010_Intro/45_Distributed.html">
            
                
                    <a href="../010_Intro/45_Distributed.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.9.</b>
                        
                         分布式
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="1.10" data-path="010_Intro/50_Conclusion.html">
            
                
                    <a href="../010_Intro/50_Conclusion.html">
                        <i class="fa fa-check"></i>
                        
                            <b>1.10.</b>
                        
                         结语
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="2" data-path="020_Distributed_Cluster/00_Intro.html">
            
                
                    <a href="../020_Distributed_Cluster/00_Intro.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                         分布式集群
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="2.1" data-path="020_Distributed_Cluster/05_Empty_cluster.html">
            
                
                    <a href="../020_Distributed_Cluster/05_Empty_cluster.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                         空集群
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.2" data-path="020_Distributed_Cluster/10_Cluster_health.html">
            
                
                    <a href="../020_Distributed_Cluster/10_Cluster_health.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                         集群健康
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.3" data-path="020_Distributed_Cluster/15_Add_an_index.html">
            
                
                    <a href="../020_Distributed_Cluster/15_Add_an_index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                         添加索引
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.4" data-path="020_Distributed_Cluster/20_Add_failover.html">
            
                
                    <a href="../020_Distributed_Cluster/20_Add_failover.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                         故障转移
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.5" data-path="020_Distributed_Cluster/25_Scale_horizontally.html">
            
                
                    <a href="../020_Distributed_Cluster/25_Scale_horizontally.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                         横向扩展
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.6" data-path="020_Distributed_Cluster/30_Scale_more.html">
            
                
                    <a href="../020_Distributed_Cluster/30_Scale_more.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                         更多扩展
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="2.7" data-path="020_Distributed_Cluster/35_Coping_with_failure.html">
            
                
                    <a href="../020_Distributed_Cluster/35_Coping_with_failure.html">
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                         应对故障
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="3" data-path="030_Data/00_Intro.html">
            
                
                    <a href="../030_Data/00_Intro.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                         数据
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="3.1" data-path="030_Data/05_Document.html">
            
                
                    <a href="../030_Data/05_Document.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                         文档
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.2" data-path="030_Data/10_Index.html">
            
                
                    <a href="../030_Data/10_Index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                         索引
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.3" data-path="030_Data/15_Get.html">
            
                
                    <a href="../030_Data/15_Get.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.3.</b>
                        
                         获取
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.4" data-path="030_Data/20_Exists.html">
            
                
                    <a href="../030_Data/20_Exists.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.4.</b>
                        
                         存在
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.5" data-path="030_Data/25_Update.html">
            
                
                    <a href="../030_Data/25_Update.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.5.</b>
                        
                         更新
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.6" data-path="030_Data/30_Create.html">
            
                
                    <a href="../030_Data/30_Create.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.6.</b>
                        
                         创建
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.7" data-path="030_Data/35_Delete.html">
            
                
                    <a href="../030_Data/35_Delete.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.7.</b>
                        
                         删除
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter active" data-level="3.8" data-path="030_Data/40_Version_control.html">
            
                
                    <a href="../030_Data/40_Version_control.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.8.</b>
                        
                         版本控制
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.9" data-path="030_Data/45_Partial_update.html">
            
                
                    <a href="../030_Data/45_Partial_update.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.9.</b>
                        
                         局部更新
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.10" data-path="030_Data/50_Mget.html">
            
                
                    <a href="../030_Data/50_Mget.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.10.</b>
                        
                         Mget
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.11" data-path="030_Data/55_Bulk.html">
            
                
                    <a href="../030_Data/55_Bulk.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.11.</b>
                        
                         批量
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="3.12" data-path="030_Data/60_Conclusion.html">
            
                
                    <a href="../030_Data/60_Conclusion.html">
                        <i class="fa fa-check"></i>
                        
                            <b>3.12.</b>
                        
                         结语
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="4" data-path="040_Distributed_CRUD/00_Intro.html">
            
                
                    <a href="../040_Distributed_CRUD/00_Intro.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                         分布式增删改查
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="4.1" data-path="040_Distributed_CRUD/05_Routing.html">
            
                
                    <a href="../040_Distributed_CRUD/05_Routing.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.1.</b>
                        
                         路由
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.2" data-path="040_Distributed_CRUD/10_Shard_interaction.html">
            
                
                    <a href="../040_Distributed_CRUD/10_Shard_interaction.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.2.</b>
                        
                         分片交互
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.3" data-path="040_Distributed_CRUD/15_Create_index_delete.html">
            
                
                    <a href="../040_Distributed_CRUD/15_Create_index_delete.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.3.</b>
                        
                         新建、索引和删除
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.4" data-path="040_Distributed_CRUD/20_Retrieving.html">
            
                
                    <a href="../040_Distributed_CRUD/20_Retrieving.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.4.</b>
                        
                         检索
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.5" data-path="040_Distributed_CRUD/25_Partial_updates.html">
            
                
                    <a href="../040_Distributed_CRUD/25_Partial_updates.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.5.</b>
                        
                         局部更新
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.6" data-path="040_Distributed_CRUD/30_Bulk_requests.html">
            
                
                    <a href="../040_Distributed_CRUD/30_Bulk_requests.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.6.</b>
                        
                         批量请求
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="4.7" data-path="040_Distributed_CRUD/35_Bulk_format.html">
            
                
                    <a href="../040_Distributed_CRUD/35_Bulk_format.html">
                        <i class="fa fa-check"></i>
                        
                            <b>4.7.</b>
                        
                         批量格式
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="5" data-path="050_Search/00_Intro.html">
            
                
                    <a href="../050_Search/00_Intro.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.</b>
                        
                         搜索
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="5.1" data-path="050_Search/05_Empty_search.html">
            
                
                    <a href="../050_Search/05_Empty_search.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.1.</b>
                        
                         空搜索
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.2" data-path="050_Search/10_Multi_index_multi_type.html">
            
                
                    <a href="../050_Search/10_Multi_index_multi_type.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.2.</b>
                        
                         多索引和多类型
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.3" data-path="050_Search/15_Pagination.html">
            
                
                    <a href="../050_Search/15_Pagination.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.3.</b>
                        
                         分页
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="5.4" data-path="050_Search/20_Query_string.html">
            
                
                    <a href="../050_Search/20_Query_string.html">
                        <i class="fa fa-check"></i>
                        
                            <b>5.4.</b>
                        
                         查询语句
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    
        
        <li class="chapter " data-level="6" data-path="052_Mapping_Analysis/00_Intro.html">
            
                
                    <a href="../052_Mapping_Analysis/00_Intro.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.</b>
                        
                         映射和分析
                    </a>
                
            
            
            <ul class="articles">
                
    
        
        <li class="chapter " data-level="6.1" data-path="052_Mapping_Analysis/25_Data_type_differences.html">
            
                
                    <a href="../052_Mapping_Analysis/25_Data_type_differences.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.1.</b>
                        
                         数据类型差异
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.2" data-path="052_Mapping_Analysis/30_Exact_vs_full_text.html">
            
                
                    <a href="../052_Mapping_Analysis/30_Exact_vs_full_text.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.2.</b>
                        
                         提取对决全文
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.3" data-path="052_Mapping_Analysis/35_Inverted_index.html">
            
                
                    <a href="../052_Mapping_Analysis/35_Inverted_index.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.3.</b>
                        
                         倒排索引
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.4" data-path="052_Mapping_Analysis/40_Analysis.html">
            
                
                    <a href="../052_Mapping_Analysis/40_Analysis.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.4.</b>
                        
                         分析
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.5" data-path="052_Mapping_Analysis/45_Mapping.html">
            
                
                    <a href="../052_Mapping_Analysis/45_Mapping.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.5.</b>
                        
                         映射
                    </a>
                
            
            
        </li>
    
        
        <li class="chapter " data-level="6.6" data-path="052_Mapping_Analysis/50_Complex_datatypes.html">
            
                
                    <a href="../052_Mapping_Analysis/50_Complex_datatypes.html">
                        <i class="fa fa-check"></i>
                        
                            <b>6.6.</b>
                        
                         复合类型
                    </a>
                
            
            
        </li>
    

            </ul>
            
        </li>
    


        
        <li class="divider"></li>
        <li>
            <a href="http://www.gitbook.io/" target="blank" class="gitbook-link">Published using GitBook</a>
        </li>
        
    </ul>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header">
    <!-- Actions Left -->
    <a href="#" class="btn pull-left toggle-summary" aria-label="Toggle summary"><i class="fa fa-align-justify"></i></a>
    <a href="#" class="btn pull-left toggle-search" aria-label="Toggle search"><i class="fa fa-search"></i></a>
    
    <div id="font-settings-wrapper" class="dropdown pull-left">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle font settings"><i class="fa fa-font"></i>
        </a>
        <div class="dropdown-menu font-settings">
    <div class="dropdown-caret">
        <span class="caret-outer"></span>
        <span class="caret-inner"></span>
    </div>

    <div class="buttons">
        <button type="button" id="reduce-font-size" class="button size-2">A</button>
        <button type="button" id="enlarge-font-size" class="button size-2">A</button>
    </div>

    <div class="buttons font-family-list">
        <button type="button" data-font="0" class="button">Serif</button>
        <button type="button" data-font="1" class="button">Sans</button>
    </div>

    <div class="buttons color-theme-list">
        <button type="button" id="color-theme-preview-0" class="button size-3" data-theme="0">White</button>
        <button type="button" id="color-theme-preview-1" class="button size-3" data-theme="1">Sepia</button>
        <button type="button" id="color-theme-preview-2" class="button size-3" data-theme="2">Night</button>
    </div>
</div>

    </div>

    <!-- Actions Right -->
    
    <div class="dropdown pull-right">
        <a href="#" class="btn toggle-dropdown" aria-label="Toggle share dropdown"><i class="fa fa-share-alt"></i>
        </a>
        <div class="dropdown-menu font-settings dropdown-left">
            <div class="dropdown-caret">
                <span class="caret-outer"></span>
                <span class="caret-inner"></span>
            </div>
            <div class="buttons">
                <button type="button" data-sharing="twitter" class="button">Twitter</button>
                <button type="button" data-sharing="google-plus" class="button">Google</button>
                <button type="button" data-sharing="facebook" class="button">Facebook</button>
                <button type="button" data-sharing="weibo" class="button">Weibo</button>
                <button type="button" data-sharing="instapaper" class="button">Instapaper</button>
            </div>
        </div>
    </div>
    

    
    <a href="#" target="_blank" class="btn pull-right google-plus-sharing-link sharing-link" data-sharing="google-plus" aria-label="Share on Google Plus"><i class="fa fa-google-plus"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right facebook-sharing-link sharing-link" data-sharing="facebook" aria-label="Share on Facebook"><i class="fa fa-facebook"></i></a>
    
    
    <a href="#" target="_blank" class="btn pull-right twitter-sharing-link sharing-link" data-sharing="twitter" aria-label="Share on Twitter"><i class="fa fa-twitter"></i></a>
    
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >Elasticsearch 权威指南（中文版）</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-gitbook_24">
                    
                        <h2 id="">处理冲突</h2>
<p>当使用<code>index</code> API更新文档的时候，我们读取原始文档，做修改，然后将<strong>整个文档(whole document)</strong>一次性重新索引。最近的索引请求会生效——Elasticsearch中只存储最后被索引的任何文档。如果其他人同时也修改了这个文档，他们的修改将会丢失。</p>
<p>很多时候，这并不是一个问题。或许我们主要的数据存储在关系型数据库中，然后拷贝数据到Elasticsearch中只是为了可以用于搜索。或许两个人同时修改文档的机会很少。亦或者偶尔的修改丢失对于我们的工作来说并无大碍。</p>
<p>但有时丢失修改是一个<strong>很严重</strong>的问题。想象一下我们使用Elasticsearch存储大量在线商店的库存信息。每当销售一个商品，Elasticsearch中的库存就要减一。</p>
<p>一天，老板决定做一个促销。瞬间，我们每秒就销售了几个商品。想象两个同时运行的web进程，两者同时处理一件商品的订单：</p>
<p><img src="../images/03-01_concurrency.png" alt="img-data-lww"></p>
<p><code>web_1</code>让<code>stock_count</code>失效是因为<code>web_2</code>没有察觉到<code>stock_count</code>的拷贝已经过期（译者注：<code>web_1</code>取数据，减一后更新了<code>stock_count</code>。可惜在<code>web_1</code>更新<code>stock_count</code>前它就拿到了数据，这个数据已经是过期的了，当<code>web_2</code>再回来更新<code>stock_count</code>时这个数字就是错的。这样就会造成看似卖了一件东西，其实是卖了两件，这个应该属于幻读。）。结果是我们认为自己确实还有更多的商品，最终顾客会因为销售给他们没有的东西而失望。</p>
<p>变化越是频繁，或读取和更新间的时间越长，越容易丢失我们的更改。</p>
<p>在数据库中，有两种通用的方法确保在并发更新时修改不丢失：</p>
<h3 id="pessimistic-concurrency-control">悲观并发控制（Pessimistic concurrency control）</h3>
<p>这在关系型数据库中被广泛的使用，假设冲突的更改经常发生，为了解决冲突我们把访问区块化。典型的例子是在读一行数据前锁定这行，然后确保只有加锁的那个线程可以修改这行数据。</p>
<h3 id="optimistic-concurrency-control">乐观并发控制（Optimistic concurrency control）：</h3>
<p>被Elasticsearch使用，假设冲突不经常发生，也不区块化访问，然而，如果在读写过程中数据发生了变化，更新操作将失败。这时候又程序决定在失败后如何解决冲突。实际情况中，可以重新尝试更新，刷新数据（重新读取）或者直接反馈给用户。</p>
<h2 id="">乐观并发控制</h2>
<p>Elasticsearch是分布式的。当文档被创建、更新或删除，文档的新版本会被复制到集群的其它节点。Elasticsearch即是同步的又是异步的，意思是这些复制请求都是平行发送的，并<strong>无序(out of sequence)</strong>的到达目的地。这就需要一种方法确保老版本的文档永远不会覆盖新的版本。</p>
<p>上文我们提到<code>index</code>、<code>get</code>、<code>delete</code>请求时，我们指出每个文档都有一个<code>_version</code>号码，这个号码在文档被改变时加一。Elasticsearch使用这个<code>_version</code>保证所有修改都被正确排序。当一个旧版本出现在新版本之后，它会被简单的忽略。</p>
<p>我们利用<code>_version</code>的这一优点确保数据不会因为修改冲突而丢失。我们可以指定文档的<code>verion</code>来做想要的更改。如果那个版本号不是现在的，我们的请求就失败了。</p>
<p>Let&#39;s create a new blog post:
让我们创建一个新的博文：</p>
<pre><code class="lang-Javascript">PUT /website/blog/<span class="hljs-number">1</span>/_create
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Just trying this out..."</span>
}
</code></pre>
<p>响应体告诉我们这是一个新建的文档，它的<code>_version</code>是<code>1</code>。现在假设我们要编辑这个文档：把数据加载到web表单中，修改，然后保存成新版本。</p>
<p>首先我们检索文档：</p>
<pre><code class="lang-Javascript">GET /website/blog/<span class="hljs-number">1</span>
</code></pre>
<p>响应体包含相同的<code>_version</code>是<code>1</code></p>
<pre><code class="lang-Javascript">{
  <span class="hljs-string">"_index"</span> :   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span> :    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span> :      <span class="hljs-string">"1"</span>,
  <span class="hljs-string">"_version"</span> : <span class="hljs-number">1</span>,
  <span class="hljs-string">"found"</span> :    <span class="hljs-literal">true</span>,
  <span class="hljs-string">"_source"</span> :  {
      <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
      <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Just trying this out..."</span>
  }
}
</code></pre>
<p>现在，当我们通过重新索引文档保存修改时，我们这样指定了<code>version</code>参数：</p>
<pre><code class="lang-Javascript">PUT /website/blog/<span class="hljs-number">1</span>?version=<span class="hljs-number">1</span> &lt;<span class="hljs-number">1</span>&gt;
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Starting to get the hang of this..."</span>
}
</code></pre>
<ul>
<li><1> 我们只希望文档的<code>_version</code>是<code>1</code>时更新才生效。</li>
</ul>
<p>This request succeeds, and the response body tells us that the <code>_version</code>
has been incremented to <code>2</code>:</p>
<p>请求成功，响应体告诉我们<code>_version</code>已经增加到<code>2</code>：</p>
<pre><code class="lang-Javascript">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"1"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">2</span>
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">false</span>
}
</code></pre>
<p>然而，如果我们重新运行相同的索引请求，依旧指定<code>version=1</code>，Elasticsearch将返回<code>409 Conflict</code>状态的HTTP响应。响应体类似这样：</p>
<pre><code class="lang-Javascript">{
  &quot;error&quot; : &quot;VersionConflictEngineException[[website][2] [blog][1]:
             version conflict, current [2], provided [1]]&quot;,
  &quot;status&quot; : 409
}
</code></pre>
<p>这告诉我们当前<code>_version</code>是<code>2</code>，但是我们指定想要更新的版本是<code>1</code>。</p>
<p>我们需要做什么取决于程序的需求。我们可以告知用户其他人修改了文档，你应该在保存前再看一下。而对于上文提到的商品<code>stock_count</code>，我们需要重新检索最新文档然后申请新的更改操作。</p>
<p>所有更新和删除文档的请求都接受<code>version</code>参数，它可以允许在你的代码中增加乐观锁控制。</p>
<h2 id="">使用外部版本控制系统</h2>
<p>一种常见的结构是使用一些其他的数据库做为主数据库，然后使用Elasticsearch搜索数据，这意味着所有主数据库发生变化，就要将其拷贝到Elasticsearch中。如果有多个进程负责这些数据的同步，就会遇到上面提到的并发问题。</p>
<p>如果主数据库有版本字段——或一些类似于<code>timestamp</code>等可以用于版本控制的字段——是你就可以在Elasticsearch的查询字符串后面添加<code>version_type=external</code>来使用这些版本号。版本号必须是整数，大于零小于<code>9.2e+18</code>——Java中的正的<code>long</code>。</p>
<p>外部版本号与之前说的内部版本号在处理的时候有些不同。它不再检查<code>_version</code>是否与请求中指定的<strong>一致</strong>，而是检查是否<strong>小于</strong>指定的版本。如果请求成功，外部版本号就会被存储到<code>_version</code>中。</p>
<p>外部版本号不仅在索引和删除请求中指定，也可以在<strong>创建(create)</strong>新文档中指定。</p>
<p>例如，创建一个包含外部版本号<code>5</code>的新博客，我们可以这样做：</p>
<pre><code class="lang-Javascript">PUT /website/blog/<span class="hljs-number">2</span>?version=<span class="hljs-number">5</span>&amp;version_type=external
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first external blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"Starting to get the hang of this..."</span>
}
</code></pre>
<p>在响应中，我们能看到当前的<code>_version</code>号码是<code>5</code>：</p>
<pre><code class="lang-Javascript">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"2"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">5</span>,
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">true</span>
}
</code></pre>
<p>现在我们更新这个文档，指定一个新<code>version</code>号码为<code>10</code>：</p>
<pre><code class="lang-Javascript">PUT /website/blog/<span class="hljs-number">2</span>?version=<span class="hljs-number">10</span>&amp;version_type=external
{
  <span class="hljs-string">"title"</span>: <span class="hljs-string">"My first external blog entry"</span>,
  <span class="hljs-string">"text"</span>:  <span class="hljs-string">"This is a piece of cake..."</span>
}
</code></pre>
<p>请求成功的设置了当前<code>_version</code>为<code>10</code>：</p>
<pre><code class="lang-Javascript">{
  <span class="hljs-string">"_index"</span>:   <span class="hljs-string">"website"</span>,
  <span class="hljs-string">"_type"</span>:    <span class="hljs-string">"blog"</span>,
  <span class="hljs-string">"_id"</span>:      <span class="hljs-string">"2"</span>,
  <span class="hljs-string">"_version"</span>: <span class="hljs-number">10</span>,
  <span class="hljs-string">"created"</span>:  <span class="hljs-literal">false</span>
}
</code></pre>
<p>如果你重新运行这个请求，就会返回一个像之前一样的冲突错误，因为指定的外部版本号不大于当前在Elasticsearch中的版本。</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../030_Data/35_Delete.html" class="navigation navigation-prev " aria-label="Previous page: 删除"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../030_Data/45_Partial_update.html" class="navigation navigation-next " aria-label="Next page: 局部更新"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="https://cdn.mathjax.org/mathjax/2.4-latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-mathjax/plugin.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"fontSettings":{"theme":null,"family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
